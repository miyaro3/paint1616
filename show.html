<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Pixel Art Overlay</title>
    <style>
        body { margin: 0; overflow: hidden; background: transparent; font-family: 'Arial', sans-serif; }
        #stage { width: 100vw; height: 100vh; position: relative; }
        
        .art-container {
            position: absolute; right: -150px; top: 10px;
            display: flex; flex-direction: column; align-items: center;
            animation: move linear forwards;
        }

        .pixel-grid {
            display: grid;
            grid-template-columns: repeat(16, 5px);
            grid-template-rows: repeat(16, 5px);
            width: 80px; height: 80px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px; overflow: hidden;
        }

        .px { width: 5px; height: 5px; }

        .user-name {
            margin-top: 4px; font-size: 12px; font-weight: bold; color: white;
            text-shadow: 1px 1px 2px black, -1px -1px 2px black;
            white-space: nowrap;
        }

        @keyframes move {
            from { transform: translateX(0); }
            to { transform: translateX(-120vw); }
        }
    </style>
</head>
<body>
    <div id="stage"></div>

    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <script>
        // paint.htmlと完全に一致するパレット定義
        const PALETTES = {
            "0": ['transparent','#ffffff','#888888','#222222','#ff4b2b','#33cc33','#0077ff','#ffee00','#ff99cc','#66ffff','#ccff33','#8b4513','#b22222','#000080','#ff8c00','#000000'],
            "1": ['transparent','#fff5eb','#fde5d2','#f9d4b8','#f3b08c','#e3906c','#c07254','#91553d','#ff66a3','#ff0066','#9900ff','#442211','#55ccff','#ffffff','#222222','#000000'],
            "2": ['transparent','#ffffff','#f8f8f8','#e0e0e0','#cccccc','#b0b0b0','#999999','#808080','#666666','#505050','#404040','#303030','#202020','#101010','#050505','#000000'],
            "3": ['transparent','#ff6b6b','#fa5252','#f03e3e','#e03131','#c92a2a','#ffa94d','#fd7e14','#f76707','#e8590c','#d9480f','#ffffff','#ffec99','#fab005','#222222','#000000'],
            "4": ['transparent','#339af0','#228be6','#1c7ed6','#1971c2','#1864ab','#38d9a9','#20c997','#12b886','#0ca678','#099268','#ffffff','#a5d8ff','#111111','#222222','#000000'],
            "5": ['transparent','#f8f8f8','#bcbcbc','#7c7c7c','#f8d878','#f8a000','#f83800','#d80000','#008800','#00a800','#0058f8','#3cbcfc','#0000bc','#6844fc','#ffffff','#000000'],
            "6": ['transparent','#ffb7b2','#ffdac1','#e2f0cb','#b5ead7','#c7ceea','#ffc6ff','#9bf6ff','#a0c4ff','#bdb2ff','#fffffc','#ffffff','#333333','#aaaaaa','#222222','#000000'],
            "7": ['transparent','#ff0000','#cc0000','#990000','#660000','#330000','#ff8888','#ffcccc','#ffffff','#eeeeee','#cccccc','#999999','#666666','#333333','#111111','#000000'],
            "8": ['transparent','#00ff00','#ff00ff','#00ffff','#ffff00','#ff0000','#ffffff','#003300','#330033','#003333','#333300','#330000','#444444','#888888','#222222','#000000'],
            "9": ['transparent','#2d5a27','#1e3f1a','#4a7c44','#6b8e23','#8fbc8f','#556b2f','#a2ad91','#deb887','#8b4513','#5d4037','#ffffff','#cccccc','#444444','#222222','#000000'],
            "a": ['transparent','#0077be','#005b96','#03396c','#011f4b','#6497b1','#b3cde0','#009688','#4db6ac','#80cbc4','#ffffff','#dddddd','#aaaaaa','#333333','#111111','#000000'],
            "b": ['transparent','#ff4500','#ff6347','#ff8c00','#ffa500','#ffd700','#2f4f4f','#708090','#191970','#000080','#483d8b','#ffffff','#aaaaaa','#333333','#111111','#000000'],
            "c": ['transparent','#9bbc0f','#8bab0f','#306230','#0f380f','#ffffff','#dddddd','#bbbbbb','#999999','#777777','#555555','#333333','#111111','#050505','#222222','#000000'],
            "d": ['transparent','#a63d33','#e0815e','#6b4a3e','#f2e8d5','#bfbd97','#8c9e5e','#5e6146','#3e4a3d','#2b3a2d','#1a201a','#ffffff','#cccccc','#888888','#222222','#000000'],
            "e": ['transparent','#5d001e','#9a1750','#ee4c7c','#ff66aa','#cc3366','#990033','#ffcccc','#ff99cc','#ffffff','#eeeeee','#cccccc','#999999','#444444','#222222','#000000'],
            "f": ['transparent','#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff','#ffffff','#808080','#800000','#008000','#000080','#808000','#800080','#444444','#000000']
        };

        let moveSpeed = 20; // 秒（右から左までかかる時間）

        // URLパラメータからチャンネル名を取得
        const params = new URLSearchParams(window.location.search);
        const channel = params.get('channel');

        if (channel) {
            ComfyJS.Init(channel);
        } else {
            alert("URLに ?channel=あなたのチャンネル名 を入れてください");
        }

        ComfyJS.onCommand = (user, command, message, flags, extra) => {
            if (command === "draw" && message) {
                createArt(user, message);
            }
            
            // 管理者用：速度変更
            if ((flags.broadcaster || flags.mod) && command === "speed") {
                const s = parseInt(message);
                if (s > 0) moveSpeed = s;
            }
        };

        function createArt(user, data) {
            const palKey = data[0].toLowerCase();
            const colors = PALETTES[palKey] || PALETTES["0"];
            const pixelData = data.substring(1);

            const container = document.createElement('div');
            container.className = 'art-container';
            container.style.animationDuration = moveSpeed + "s";
            // 重ならないように高さをランダムにする（配信画面上部100px以内を想定）
            container.style.top = Math.random() * 20 + "px";

            const grid = document.createElement('div');
            grid.className = 'pixel-grid';

            // 圧縮データの展開
            let pCount = 0;
            for (let i = 0; i < pixelData.length; i += 2) {
                if (pCount >= 256) break;
                const colorIdx = parseInt(pixelData[i], 16);
                const repeat = parseInt(pixelData[i + 1], 16);
                
                for (let r = 0; r < repeat; r++) {
                    if (pCount < 256) {
                        const px = document.createElement('div');
                        px.className = 'px';
                        px.style.backgroundColor = colors[colorIdx] || 'transparent';
                        grid.appendChild(px);
                        pCount++;
                    }
                }
            }

            // 256マスに足りない分を透明で埋める
            while (pCount < 256) {
                const px = document.createElement('div');
                px.className = 'px';
                grid.appendChild(px);
                pCount++;
            }

            const nameTag = document.createElement('div');
            nameTag.className = 'user-name';
            nameTag.innerText = user;

            container.appendChild(grid);
            container.appendChild(nameTag);
            document.getElementById('stage').appendChild(container);

            // アニメーション終了後に削除
            container.onanimationend = () => container.remove();
        }
    </script>
</body>
</html>
